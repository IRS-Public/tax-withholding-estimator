<?xml version="1.0"?>
<?xml-model href="./FactDictionaryModule.rng"?>
<FactDictionaryModule>
  <Facts>
    <Fact path="/pensions">
      <Writable>
        <Collection/>
      </Writable>
    </Fact>
    <Fact path="/pensions/*/filerAssignment">
      <Description>Whether this pension is attributed to the primary filer or spouse if MFJ</Description>
      <Override>
        <!-- If the filing status is non-MFJ, the default must be a self assignment -->
        <Condition>
          <Not>
            <Dependency path="/isFilingStatusMFJ"/>
          </Not>
        </Condition>
        <Default>
          <Enum optionsPath="/filerAssignmentOption">self</Enum>
        </Default>
      </Override>
      <Writable>
        <Enum optionsPath="/filerAssignmentOption"/>
      </Writable>
    </Fact>
    <!-- TODO: Need isAllYear fact -->
    <Fact path="/pensions/*/startDate">
      <Description>The start date of the pension this year</Description>
      <Writable>
        <Day/>
      </Writable>
    </Fact>
    <Fact path="/pensions/*/endDate">
      <Description>The end date of the pension this year</Description>
      <Writable>
        <Day/>
      </Writable>
    </Fact>
    <Fact path="/pensions/*/payFrequency">
      <Writable>
        <Enum optionsPath="/payFrequencyOptions"/>
      </Writable>
    </Fact>
    <Fact path="/pensions/*/mostRecentPayDate">
      <Writable>
        <Day/>
      </Writable>
    </Fact>
    <Fact path="/pensions/*/averagePayPerPayPeriod">
      <Writable>
        <Dollar/>
      </Writable>
      <Placeholder>
        <Dollar>0</Dollar>
      </Placeholder>
    </Fact>
    <Fact path="/pensions/*/yearToDateIncome">
      <Writable>
        <Dollar/>
      </Writable>
      <Placeholder>
        <Dollar>0</Dollar>
      </Placeholder>
    </Fact>
    <Fact path="/pensions/*/averageWithholdingPerPayPeriod">
      <Description>Average withholding from a specific pension per pay-period.</Description>
      <Writable>
        <Dollar/>
      </Writable>
      <Placeholder>
        <Dollar>0</Dollar>
      </Placeholder>
    </Fact>
    <Fact path="/pensions/*/yearToDateWithholding">
      <Writable>
        <Dollar/>
      </Writable>
      <Placeholder>
        <Dollar>0</Dollar>
      </Placeholder>
    </Fact>
    <Fact path="/pensionsAssignedToSelf">
      <Derived>
        <Filter path="/pensions">
          <Equal>
            <Left>
              <Dependency path="filerAssignment"/>
            </Left>
            <Right>
              <Enum optionsPath="/filerAssignmentOption">self</Enum>
            </Right>
          </Equal>
        </Filter>
      </Derived>
    </Fact>
    <Fact path="/pensionsAssignedToSpouse">
      <Derived>
        <Filter path="/pensions">
          <Equal>
            <Left>
              <Dependency path="filerAssignment"/>
            </Left>
            <Right>
              <Enum optionsPath="/filerAssignmentOption">spouse</Enum>
            </Right>
          </Equal>
        </Filter>
      </Derived>
    </Fact>
    <Fact path="/pensions/*/isPayFrequencyWeekly">
      <Derived>
        <Equal>
          <Left>
            <Dependency path="../payFrequency"/>
          </Left>
          <Right>
            <Enum optionsPath="/payFrequencyOptions">weekly</Enum>
          </Right>
        </Equal>
      </Derived>
    </Fact>
    <Fact path="/pensions/*/isPayFrequencyBiWeekly">
      <Derived>
        <Equal>
          <Left>
            <Dependency path="../payFrequency"/>
          </Left>
          <Right>
            <Enum optionsPath="/payFrequencyOptions">biWeekly</Enum>
          </Right>
        </Equal>
      </Derived>
    </Fact>
    <Fact path="/pensions/*/isPayFrequencySemiMonthly">
      <Derived>
        <Equal>
          <Left>
            <Dependency path="../payFrequency"/>
          </Left>
          <Right>
            <Enum optionsPath="/payFrequencyOptions">semiMonthly</Enum>
          </Right>
        </Equal>
      </Derived>
    </Fact>
    <Fact path="/pensions/*/isPayFrequencyMonthly">
      <Derived>
        <Equal>
          <Left>
            <Dependency path="../payFrequency"/>
          </Left>
          <Right>
            <Enum optionsPath="/payFrequencyOptions">monthly</Enum>
          </Right>
        </Equal>
      </Derived>
    </Fact>
    <Fact path="/pensions/*/semimonthlyEarlierPayDate">
      <Description>For semimonthly pay periods, determines the earlier pay date, we assume pay dates of the 16 correspond to pay dates on the 1st</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <GreaterThan>
                <Left>
                  <Dependency path="../mostRecentPayDate/day"/>
                </Left>
                <Right>
                  <Int>15</Int>
                </Right>
              </GreaterThan>
            </When>
            <Then>
              <Subtract>
                <Minuend>
                  <Dependency path="../mostRecentPayDate"/>
                </Minuend>
                <Subtrahends>
                  <Days>15</Days>
                </Subtrahends>
              </Subtract>
            </Then>
          </Case>
          <Case>
            <When>
              <True/>
            </When>
            <Then>
              <Dependency path="../mostRecentPayDate"/>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>
    <Fact path="/pensions/*/semimonthlyLaterPayDate">
      <Description>For semimonthly pay periods, determines the later pay date</Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <LessThanOrEqual>
                <Left>
                  <Dependency path="../mostRecentPayDate/day"/>
                </Left>
                <Right>
                  <Int>15</Int>
                </Right>
              </LessThanOrEqual>
            </When>
            <!-- add 15 days by default if the 14th or 15th of feb get last day of feb -->
            <Then>
              <Switch>
                <Case>
                  <When>
                    <All>
                      <Equal>
                        <Left>
                          <Dependency path="../mostRecentPayDate/month"/>
                        </Left>
                        <Right>
                          <Int>2</Int>
                        </Right>
                      </Equal>
                      <Any>
                        <Equal>
                          <Left>
                            <Dependency path="../mostRecentPayDate/day"/>
                          </Left>
                          <Right>
                            <Int>14</Int>
                          </Right>
                        </Equal>
                        <Equal>
                          <Left>
                            <Dependency path="../mostRecentPayDate/day"/>
                          </Left>
                          <Right>
                            <Int>15</Int>
                          </Right>
                        </Equal>
                      </Any>
                    </All>
                  </When>
                  <Then>
                    <LastDayOfMonth>
                      <Dependency path="../mostRecentPayDate"/>
                    </LastDayOfMonth>
                  </Then>
                </Case>
                <Case>
                  <When>
                    <True/>
                  </When>
                  <Then>
                    <Add>
                      <Dependency path="../mostRecentPayDate"/>
                      <Days>15</Days>
                    </Add>
                  </Then>
                </Case>
              </Switch>
            </Then>
          </Case>
          <Case>
            <When>
              <True/>
            </When>
            <Then>
              <Dependency path="../mostRecentPayDate"/>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>
    <Fact path="/pensions/*/nextPayDay">
      <Derived>
        <Switch>
          <Case>
            <When>
              <Equal>
                <Left>
                  <Dependency path="../mostRecentPayDate"/>
                </Left>
                <Right>
                  <Dependency path="../semimonthlyEarlierPayDate"/>
                </Right>
              </Equal>
            </When>
            <Then>
              <Dependency path="../semimonthlyLaterPayDate"/>
            </Then>
          </Case>
          <Case>
            <When>
              <True/>
            </When>
            <Then>
              <AddPayrollMonths>
                <Dependency path="../semimonthlyEarlierPayDate"/>
                <Int>1</Int>
              </AddPayrollMonths>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>
    <Fact path="/pensions/*/payPeriodsBeforeW4ChangesAppear">
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../isPayFrequencyWeekly"/>
            </When>
            <Then>
              <Int>2</Int>
            </Then>
          </Case>
          <Case>
            <When>
              <Dependency path="../isPayFrequencyBiWeekly"/>
            </When>
            <Then>
              <Int>1</Int>
            </Then>
          </Case>
          <Case>
            <When>
              <Dependency path="../isPayFrequencySemiMonthly"/>
            </When>
            <Then>
              <Switch>
                <!-- Handle scenario when there are 2 pay periods. Only happens in the middle of Feb -->
                <Case>
                  <When>
                    <GreaterThanOrEqual>
                      <Left>
                        <Dependency path="/projectedW4EffectDate"/>
                      </Left>
                      <Right>
                        <AddPayrollMonths>
                          <Dependency path="../mostRecentPayDate"/>
                          <Int>1</Int>
                        </AddPayrollMonths>
                      </Right>
                    </GreaterThanOrEqual>
                  </When>
                  <Then>
                    <Int>2</Int>
                  </Then>
                </Case>
                <Case>
                  <When>
                    <GreaterThanOrEqual>
                      <Left>
                        <Dependency path="/projectedW4EffectDate"/>
                      </Left>
                      <Right>
                        <Dependency path="../nextPayDay"/>
                      </Right>
                    </GreaterThanOrEqual>
                  </When>
                  <Then>
                    <Int>1</Int>
                  </Then>
                </Case>
                <Case>
                  <When>
                    <True/>
                  </When>
                  <Then>
                    <Int>0</Int>
                  </Then>
                </Case>
              </Switch>
            </Then>
          </Case>
          <Case>
            <When>
              <Dependency path="../isPayFrequencyMonthly"/>
            </When>
            <Then>
              <Count>
                <GreaterThanOrEqual>
                  <Left>
                    <Dependency path="/projectedW4EffectDate"/>
                  </Left>
                  <Right>
                    <AddPayrollMonths>
                      <Dependency path="../mostRecentPayDate"/>
                      <Int>1</Int>
                    </AddPayrollMonths>
                  </Right>
                </GreaterThanOrEqual>
              </Count>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>
    <Fact path="/pensions/*/isPastJob">
      <Derived>
        <LessThanOrEqual>
          <Left>
            <Dependency path="../endDate"/>
          </Left>
          <Right>
            <Dependency path="/today"/>
          </Right>
        </LessThanOrEqual>
      </Derived>
    </Fact>
    <!-- Income/withholding Calculations -->
    <Fact path="/pensions/*/restOfYearIncome">
      <Derived>
        <Switch>
          <Case>
            <When>
              <Dependency path="../isPastJob"/>
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
          <Case>
            <When>
              <True/>
            </When>
            <Then>
              <Multiply>
                <Dependency path="../averagePayPerPayPeriod"/>
                <Dependency path="../remainingPayPeriodsRational"/>
              </Multiply>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>
    <Fact path="/pensions/*/income">
      <Derived>
        <Add>
          <Dependency path="../restOfYearIncome"/>
          <Dependency path="../yearToDateIncome"/>
        </Add>
        <!-- TODO: handle subtracting and accepting preTaxDeductions -->
      </Derived>
    </Fact>
    <Fact path="/pensions/*/lagWithholding">
      <Description>
        The amount that will be withheld in the time between today and when the W-4 is expected to
        be processed.
      </Description>
      <Derived>
        <!-- future withholding, too soon to be changed and thus incorporates lag. Does not use Pub 15-T Worksheet 1a calculation -->
        <Multiply>
          <Dependency path="../averageWithholdingPerPayPeriod"/>
          <LesserOf>
            <Dependency path="../remainingPayPeriodsRational"/>
            <!-- Casting this value to a rational -->
            <Multiply>
              <Dependency path="../payPeriodsBeforeW4ChangesAppear"/>
              <Rational>1/1</Rational>
            </Multiply>
          </LesserOf>
        </Multiply>
      </Derived>
    </Fact>
    <Fact path="/pensions/*/futureTentativeWithholding">
      <!-- future tentative withholding: result from Pub 15-T Worksheet 1A -->
      <!-- For now, we treat this as a "given" that won't change. Probably will need to revisit
      this when we get to reducing below tentative withholding. -->
      <Derived>
        <Multiply>
          <Divide>
            <Dividend>
              <Dependency path="../tentativeAnnualWithholdingAmount"/>
            </Dividend>
            <Divisors>
              <Dependency path="../payPeriodsPerYear"/>
            </Divisors>
          </Divide>
          <GreaterOf>
            <Rational>0/1</Rational>
            <Subtract>
              <Minuend>
                <Dependency path="../remainingPayPeriodsRational"/>
              </Minuend>
              <Subtrahends>
                <!-- Casting this value to a rational -->
                <Multiply>
                  <Dependency path="../payPeriodsBeforeW4ChangesAppear"/>
                  <Rational>1/1</Rational>
                </Multiply>
              </Subtrahends>
            </Subtract>
          </GreaterOf>
        </Multiply>
      </Derived>
    </Fact>
    <Fact path="/pensions/*/committedWithholding">
      <Description>
        The total amount that will be withheld from the paycheck if the W-4 is submitted today with
        no additional withholdings. This is also referred to as the "do-nothing withholding."
      </Description>
      <Derived>
        <Add>
          <Dependency path="../yearToDateWithholding"/>
          <Dependency path="../lagWithholding"/>
          <Dependency path="../futureTentativeWithholding"/>
        </Add>
      </Derived>
    </Fact>
    <Fact path="/pensionsTotalCommittedWithholding">
      <Derived>
        <CollectionSum>
          <Dependency path="/pensions/*/committedWithholding"/>
        </CollectionSum>
      </Derived>
    </Fact>
    <Fact path="/pensions/*/restOfYearWithholding">
      <Derived>
        <Switch>
          <Case>
            <When>
              <Any>
                <Dependency path="../isPastJob"/>
              </Any>
            </When>
            <Then>
              <Dollar>0</Dollar>
            </Then>
          </Case>
          <Case>
            <When>
              <True/>
            </When>
            <Then>
              <Multiply>
                <Dependency path="../remainingPayPeriodsRational"/>
                <Dependency path="../averageWithholdingPerPayPeriod"/>
              </Multiply>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>
    <Fact path="/pensions/*/endOfYearProjectedWithholding">
      <Description>The end of year amount withheld for this job if nothing is changed.</Description>
      <Derived>
        <Add>
          <Dependency path="../yearToDateWithholding"/>
          <Dependency path="../restOfYearWithholding"/>
        </Add>
      </Derived>
    </Fact>
    <Fact path="/pensionsTotalEndOfYearProjectedWithholding">
      <Derived>
        <CollectionSum>
          <Dependency path="/pensions/*/endOfYearProjectedWithholding"/>
        </CollectionSum>
      </Derived>
    </Fact>
    <Fact path="/pensionsAvailableForExtraWithholding">
      <Description>Pensions that are ended or end too soon are not candidates for extra withholding on a
        new W4.</Description>
      <Derived>
        <!-- TODO: what should we do if no pensions meet this filter? -->
        <Filter path="/pensions">
          <All>
            <Not>
              <Dependency path="isPastJob"/>
            </Not>
            <GreaterThan>
              <Left>
                <Dependency path="/pensions/*/remainingPayPeriodsInteger"/>
              </Left>
              <Right>
                <Dependency path="/pensions/*/payPeriodsBeforeW4ChangesAppear"/>
              </Right>
            </GreaterThan>
          </All>
        </Filter>
      </Derived>
    </Fact>
    <Fact path="/noJobs">
      <Derived>
        <CollectionSize>
          <Dependency path="/jobs"/>
        </CollectionSize>
      </Derived>
    </Fact>
    <Fact path="/pensionSelectedForExtraWithholding">
      <Description>
        Logic dictating which pension will be assigned additional or reduced withholding.
        If there are any jobs, then those will be assigned the withholding modifications and
        pensions will remain untouched.
      </Description>
      <Derived>
        <Switch>
          <Case>
            <When>
              <Any>
                <Not>
                  <IsComplete>
                    <Dependency path="/noJobs"/>
                  </IsComplete>
                </Not>
                <Equal>
                  <Left>
                    <Dependency path="/noJobs"/>
                  </Left>
                  <Right>
                    <Int>0</Int>
                  </Right>
                </Equal>
              </Any>
            </When>
            <Then>
              <IndexOf>
                <Collection>
                  <Filter path="/pensionsAvailableForExtraWithholding">
                    <Equal>
                      <Left>
                        <Maximum>
                          <Dependency path="/pensionsAvailableForExtraWithholding/*/restOfYearIncome"/>
                        </Maximum>
                      </Left>
                      <Right>
                        <Dependency path="restOfYearIncome"/>
                      </Right>
                    </Equal>
                  </Filter>
                </Collection>
                <Index>
                  <Int>0</Int>
                </Index>
              </IndexOf>
            </Then>
          </Case>
        </Switch>
      </Derived>
    </Fact>
    <Fact path="/hasPensionsIncome">
      <Derived>
        <GreaterThan>
          <Left>
            <Dependency path="/pensionsIncomeTotal"/>
          </Left>
          <Right>
            <Dollar>0</Dollar>
          </Right>
        </GreaterThan>
      </Derived>
    </Fact>
  </Facts>
</FactDictionaryModule>
