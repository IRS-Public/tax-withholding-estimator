<grammar xmlns="http://relaxng.org/ns/structure/1.0" datatypeLibrary="http://www.w3.org/2001/XMLSchema-datatypes">

  <start>
    <ref name="Flow"/>
  </start>

  <define name="Flow">
    <element name="FlowConfigModule">
      <ref name="flowPageStructure"/>
    </element>
  </define>

  <define name="FlowConfigModule">
    <interleave>
      <ref name="flowPageStructure"/>
    </interleave>
  </define>

  <!-- This structure is enforced for now -->
  <define name="flowPageStructure">
    <oneOrMore>
      <element name="page">
        <attribute name="title">
          <text/>
        </attribute>
        <attribute name="route">
          <data type="token"/>
        </attribute>
          <element name="section">
            <ref name="FlowConfigModuleContent"/>
          </element>
      </element>
    </oneOrMore>
  </define>

  <define name="fg-set-module">
    <element name="fg-set">
      <attribute name="path">
          <data type="anyURI"/>
      </attribute>
      <optional>
        <choice>
          <attribute name="if-false">
              <data type="anyURI"/>
          </attribute>
          <attribute name="if-true">
              <data type="anyURI"/>
          </attribute>
        </choice>
      </optional>
      <ref name="fg-set-content"/>
    </element>
  </define>

  <define name="fg-set-content">
    <element name="question">
      <ref name="FlowConfigModuleInlineContent"/>
    </element>
    <optional>
      <element name="hint">
        <ref name="FlowConfigModuleInlineContent"/>
      </element>
    </optional>
    <choice>
        <element name="input">
          <attribute name="type">
            <choice>
              <value>boolean</value>
              <value>dollar</value>
              <value>text</value>
              <value>date</value>
              <value>int</value>
            </choice>
          </attribute>
        </element>
      <element name="select">
        <attribute name="options-path">
          <data type="anyURI"/>
        </attribute>
        <oneOrMore>
          <element name="option">
            <attribute name="value">
              <data type="token"/>
            </attribute>
            <text/>
          </element>
        </oneOrMore>
      </element>
    </choice>
  </define>

  <define name="fg-collection-module">
    <element name="fg-collection">
      <attribute name="path">
          <data type="anyURI"/>
      </attribute>
      <optional>
        <attribute name="item-name">
          <text />
        </attribute>
      </optional>
      <interleave>
        <oneOrMore>
          <ref name="fg-set-module"></ref>
        </oneOrMore>
        <zeroOrMore>
          <ref name="HtmlBlockContent"/>
        </zeroOrMore>
      </interleave>
    </element>
  </define>

  <define name="fg-reset-module">
    <element name="fg-reset">
      <element name="button">
        <attribute name="class">
         <text/>
        </attribute>
        <attribute name="type">
          <value>reset</value>
        </attribute>
        <text/>
      </element>
    </element>
  </define>

  <define name="fg-show-module">
    <element name="fg-show">
      <attribute name="path">
          <data type="anyURI"/>
      </attribute>
    </element>
  </define>

  <define name="HtmlBlockContent">
    <choice>
      <element name="h1"><ref name="FlowConfigModuleInlineContent"/></element>
      <element name="h2">
        <optional>
          <group>
            <attribute name="condition">
                <data type="anyURI"/>
            </attribute>
            <attribute name="operator">
              <choice>
                <value>isTrue</value>
                <value>isFalse</value>
              </choice>
            </attribute>
          </group>
        </optional>
        <ref name="FlowConfigModuleInlineContent"/>
      </element>
      <element name="h3">
        <optional>
          <group>
            <attribute name="condition">
                <data type="anyURI"/>
            </attribute>
            <attribute name="operator">
              <choice>
                <value>isTrue</value>
                <value>isFalse</value>
              </choice>
            </attribute>
          </group>
        </optional>
        <ref name="FlowConfigModuleInlineContent"/>
      </element>
      <element name="p">
        <optional>
          <group>
            <attribute name="condition">
                <data type="anyURI"/>
            </attribute>
            <attribute name="operator">
              <choice>
                <value>isTrue</value>
                <value>isFalse</value>
              </choice>
            </attribute>
          </group>
        </optional>
        <ref name="FlowConfigModuleInlineContent"/>
      </element>
      <element name="table">
        <attribute name="class">
         <text/>
        </attribute>
        <ref name="TableContent"/>
      </element>
    </choice>
  </define>

  <define name="FlowConfigModuleInlineContent">
    <mixed>
      <zeroOrMore>
        <choice>
          <element name="strong"><ref name="FlowConfigModuleInlineContent"/></element>
          <ref name="fg-show-module"/>
        </choice>
      </zeroOrMore>
    </mixed>
  </define>

  <define name="TableContent">
    <optional>
      <element name="caption"><ref name="FlowConfigModuleInlineContent"/></element>
    </optional>
    <choice>
      <!-- Table with explicit sections -->
      <group>
        <optional>
          <element name="thead"><ref name="TableRowGroup"/></element>
        </optional>
        <optional>
          <element name="tfoot"><ref name="TableRowGroup"/></element>
        </optional>
        <zeroOrMore>
          <element name="tbody"><ref name="TableRowGroup"/></element>
        </zeroOrMore>
      </group>
      <!-- Table with direct rows (implicit tbody) -->
      <oneOrMore>
        <element name="tr"><ref name="TableRow"/></element>
      </oneOrMore>
    </choice>
  </define>

  <define name="TableRowGroup">
    <oneOrMore>
      <element name="tr"><ref name="TableRow"/></element>
    </oneOrMore>
  </define>

  <define name="TableRow">
  <oneOrMore>
    <choice>
      <element name="th">
        <optional>
          <attribute name="scope">
            <choice>
              <value>row</value>
              <value>col</value>
            </choice>
          </attribute>
        </optional>
        <ref name="TableCellContent"/>
      </element>
      <element name="td">
        <optional>
          <attribute name="scope">
            <choice>
              <value>row</value>
              <value>col</value>
            </choice>
          </attribute>
        </optional>
        <ref name="TableCellContent"/>
      </element>
    </choice>
  </oneOrMore>
</define>

  <define name="TableCellContent">
    <ref name="FlowConfigModuleInlineContent"/>
  </define>

  <define name="FlowConfigModuleContent">
    <mixed>
      <zeroOrMore>
        <choice>
          <!--
            These 4 FlowConfigModule XML elements are directly translated to their HTML equivalents by the flow code.
            If we add more of the same in the future, those elements would go here.
            These rules essentially say these can appear in any order and can be nested within each other.
           -->
          <ref name="HtmlBlockContent"/>
          <ref name="fg-set-module"/>
          <ref name="fg-collection-module"/>
          <ref name="fg-reset-module"/>
        </choice>
      </zeroOrMore>
    </mixed>
  </define>

</grammar>
